<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<div class="dashboard-layout">
  <app-navbar-admin class="sidebar"></app-navbar-admin>
  <div class="main-content">
    <div class="container">
      <!-- Section: Aperçu Général -->
      <div class="section">
        <h2 class="section-title">Aperçu Général</h2>
        <div class="kpi-grid" *ngIf="!loading; else loadingTemplate">
          <div class="kpi-card">
            <i class="fas fa-users kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalUsers }}</p>
              <p class="kpi-label">Total Utilisateurs</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-user kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalClients }}</p>
              <p class="kpi-label">Total Clients</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-wrench kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalTechnicians }}</p>
              <p class="kpi-label">Techniciens</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-headset kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalGuichetiers }}</p>
              <p class="kpi-label">Guichetiers</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-file-alt kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalRequests }}</p>
              <p class="kpi-label">Total Requêtes</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-hourglass-half kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ activeRequests }}</p>
              <p class="kpi-label" title="Requêtes en attente de traitement">Requêtes Non Traitées</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-check-circle kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ processedRequests }}</p>
              <p class="kpi-label">Requêtes Traitées</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-times-circle kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ refusedRequests }}</p>
              <p class="kpi-label">Requêtes Refusées</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-cogs kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ inProgressRequests }}</p>
              <p class="kpi-label">Requêtes en Cours</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-stopwatch kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ avgProcessingTime.days > 0 || avgProcessingTime.hours > 0 || avgProcessingTime.minutes > 0 ? (avgProcessingTime.days + 'j ' + avgProcessingTime.hours + 'h ' + avgProcessingTime.minutes + 'm') : 'N/A' }}</p>
              <p class="kpi-label">Temps Moyen de Traitement</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-building kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalMinisteres }}</p>
              <p class="kpi-label">Ministères</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-cog kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalServices }}</p>
              <p class="kpi-label">Services</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-box kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalProduits }}</p>
              <p class="kpi-label">Produits</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-calendar-alt kpi-icon"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ totalRdvs }}</p>
              <p class="kpi-label">Total RDVs</p>
            </div>
          </div>
        </div>
        <ng-template #loadingTemplate>
          <div class="loading-spinner">Chargement des données...</div>
        </ng-template>
        <div class="chart-container">
          <h3 class="text-lg font-semibold mb-4">Indicateurs de Qualité des Requêtes</h3>
          <canvas baseChart [data]="pieChartData" [options]="qualityPieChartOptions" [type]="qualityPieChartType" *ngIf="hasNonZeroData(pieChartData); else noData"></canvas>
          <ng-template #noData>
            <p class="text-center text-gray-500">Aucune donnée disponible.</p>
          </ng-template>
        </div>
        <!-- New Quality KPI Boxes -->
        <div class="kpi-grid" *ngIf="!loading">
          <div class="kpi-card">
            <i class="fas fa-check-circle kpi-icon" style="color: #22c55e;"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ qualityKpis.sameDay }}</p>
              <p class="kpi-label">Même Jour</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-clock kpi-icon" style="color: #f59e0b;"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ qualityKpis.withinTwoDays }}</p>
              <p class="kpi-label">≤ 2 Jours</p>
            </div>
          </div>
          <div class="kpi-card">
            <i class="fas fa-exclamation-triangle kpi-icon" style="color: #ef4444;"></i>
            <div class="kpi-content">
              <p class="kpi-value">{{ qualityKpis.moreThanTwoDays }}</p>
              <p class="kpi-label">> 2 Jours</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Requêtes -->
      <div class="section">
        <h2 class="section-title">Requêtes</h2>
        <div class="chart-filter">
          <label>Période :</label>
          <select [(ngModel)]="requestPeriod" (change)="loadRequestData()">
            <option value="7days">Derniers 7 jours</option>
            <option value="30days">Derniers 30 jours</option>
            <option value="custom">Personnalisé</option>
          </select>
          <div *ngIf="requestPeriod === 'custom'" class="flex space-x-2">
            <input type="date" [(ngModel)]="requestStartDate" (change)="loadRequestData()">
            <input type="date" [(ngModel)]="requestEndDate" (change)="loadRequestData()">
          </div>
        </div>
        <div class="chart-grid requests-charts" *ngIf="!loading; else loadingTemplate">
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Statut des Requêtes (Barres)</h3>
            <canvas baseChart [data]="areaChartData" [options]="areaChartOptions" [type]="areaChartType" *ngIf="hasNonZeroData(areaChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Statut des Requêtes (Pie)</h3>
            <canvas baseChart [data]="pieCssChartData" [options]="pieCssChartOptions" [type]="pieCssChartType" *ngIf="hasNonZeroData(pieCssChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Requêtes par Ministère (Pie)</h3>
            <canvas baseChart [data]="ministereChartData" [options]="pieChartOptions" [type]="pieChartType" *ngIf="hasNonZeroData(ministereChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Requêtes par Services (Pie)</h3>
            <canvas baseChart [data]="serviceChartData" [options]="pieChartOptions" [type]="pieChartType" *ngIf="hasNonZeroData(serviceChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Temps Moyen de Traitement par Statut (Bar)</h3>
            <canvas baseChart [data]="avgProcessingTimeChartData" [options]="avgProcessingTimeChartOptions" [type]="avgProcessingTimeChartType" *ngIf="hasNonZeroData(avgProcessingTimeChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Répartition des Requêtes par Jour de la Semaine (Pie)</h3>
            <canvas baseChart [data]="dayOfWeekChartData" [options]="pieChartOptions" [type]="pieChartType" *ngIf="hasNonZeroData(dayOfWeekChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
        </div>
        <!-- Subsection: Tendances des Requêtes -->
        <div class="section">
          <h2 class="section-title">Tendances des Requêtes</h2>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Tendances des Requêtes (Line)</h3>
            <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="lineChartType" *ngIf="hasNonZeroData(lineChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
        </div>
        <div class="search-bar-container">
          <div class="search-bar">
            <input type="text" [(ngModel)]="requestSearch" (input)="filterRequests()" placeholder="Rechercher une requête...">
            <button><i class="fas fa-search"></i></button>
          </div>
        </div>
        <div class="table-section">
          <h3 class="table-subtitle">Liste des Requêtes Récentes</h3>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-header">
                <tr>
                  <th>ID</th>
                  <th>Client</th>
                  <th>Statut</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let request of displayedRequests">
                  <td>{{ request.id }}</td>
                  <td>{{ request.client?.username || 'N/A' }}</td>
                  <td>
                    <span class="badge" [ngClass]="getRequestBadgeClass(request.etat)">{{ request.etat }}</span>
                  </td>
                  <td>{{ request.date ? (request.date | date:'short') : 'N/A' }}</td>
                </tr>
                <tr *ngIf="!displayedRequests.length">
                  <td colspan="4" class="text-center">Aucune requête disponible.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination-container">
            <div class="pagination">
              <button (click)="changePage(page - 1, 'requests')" [disabled]="page === 1">Précédent</button>
              <span>Page {{ page }} de {{ totalRequestPages / pageSize | number:'1.0-0' }}</span>
              <button (click)="changePage(page + 1, 'requests')" [disabled]="page * pageSize >= totalRequestPages">Suivant</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Utilisateurs -->
      <div class="section">
        <h2 class="section-title">Utilisateurs</h2>
        <div class="chart-filter">
          <label>Période :</label>
          <select [(ngModel)]="userPeriod" (change)="loadUserData()">
            <option value="7days">Derniers 7 jours</option>
            <option value="30days">Derniers 30 jours</option>
            <option value="custom">Personnalisé</option>
          </select>
          <div *ngIf="userPeriod === 'custom'" class="flex space-x-2">
            <input type="date" [(ngModel)]="userStartDate" (change)="loadUserData()">
            <input type="date" [(ngModel)]="userEndDate" (change)="loadUserData()">
          </div>
        </div>
        <div class="chart-grid" *ngIf="!loading; else loadingTemplate">
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Répartition des Rôles (Pie)</h3>
            <canvas baseChart [data]="userRoleChartData" [options]="pieChartOptions" [type]="pieChartType" *ngIf="hasNonZeroData(userRoleChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Clients par Ministère (Pie)</h3>
            <canvas baseChart [data]="clientByMinistereChartData" [options]="pieChartOptions" [type]="pieChartType" *ngIf="hasNonZeroData(clientByMinistereChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
        </div>
        <div class="search-bar-container">
          <div class="search-bar">
            <input type="text" [(ngModel)]="userSearch" (input)="filterUsers()" placeholder="Rechercher un utilisateur...">
            <button><i class="fas fa-search"></i></button>
          </div>
        </div>
        <div class="table-section">
          <h3 class="table-subtitle">Liste des Utilisateurs Actifs</h3>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-header">
                <tr>
                  <th>ID</th>
                  <th>Nom</th>
                  <th>Rôle</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of displayedUsers">
                  <td>{{ user.id }}</td>
                  <td>{{ user.username }}</td>
                  <td>
                    <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">{{ user.role }}</span>
                  </td>
                </tr>
                <tr *ngIf="!displayedUsers.length">
                  <td colspan="3" class="text-center">Aucun utilisateur disponible.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Section: RDV -->
      <div class="section">
        <h2 class="section-title">Rendez-vous</h2>
        <div class="chart-filter">
          <label>Période :</label>
          <select [(ngModel)]="rdvPeriod" (change)="loadRdvData()">
            <option value="7days">Derniers 7 jours</option>
            <option value="30days">Derniers 30 jours</option>
            <option value="custom">Personnalisé</option>
          </select>
          <div *ngIf="rdvPeriod === 'custom'" class="flex space-x-2">
            <input type="date" [(ngModel)]="rdvStartDate" (change)="loadRdvData()">
            <input type="date" [(ngModel)]="rdvEndDate" (change)="loadRdvData()">
          </div>
        </div>
        <div class="chart-grid" *ngIf="!loading; else loadingTemplate">
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Statut des RDV (Bar)</h3>
            <canvas baseChart [data]="rdvStatusChartData" [options]="barChartOptions" [type]="barChartType" *ngIf="hasNonZeroData(rdvStatusChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Charge des Techniciens (Bar)</h3>
            <canvas baseChart [data]="technicianWorkloadChartData" [options]="barChartOptions" [type]="barChartType" *ngIf="hasNonZeroData(technicianWorkloadChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune données disponible.</p>
            </ng-template>
          </div>
        </div>
        <div class="search-bar-container">
          <div class="search-bar">
            <input type="text" [(ngModel)]="rdvSearch" (input)="filterRdvs()" placeholder="Rechercher un RDV...">
            <button><i class="fas fa-search"></i></button>
          </div>
        </div>
        <div class="table-section">
          <h3 class="table-subtitle">Liste des Rendez-vous Planifiés</h3>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-header">
                <tr>
                  <th>ID</th>
                  <th>Technicien</th>
                  <th>Date</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let rdv of displayedRdvs">
                  <td>{{ rdv.id || 'N/A' }}</td>
                  <td>{{ rdv.technicien?.username || 'N/A' }}</td>
                  <td>{{ rdv.dateSouhaitee ? (rdv.dateSouhaitee | date:'short') : 'N/A' }}</td>
                  <td>
                    <span class="badge" [ngClass]="getRdvBadgeClass(rdv.status)">{{ rdv.status || 'N/A' }}</span>
                  </td>
                </tr>
                <tr *ngIf="!displayedRdvs.length">
                  <td colspan="4" class="text-center">Aucun RDV disponible.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination-container">
            <div class="pagination">
              <button (click)="changePage(page - 1, 'rdvs')" [disabled]="page === 1">Précédent</button>
              <span>Page {{ page }} de {{ totalRdvs / pageSize | number:'1.0-0' }}</span>
              <button (click)="changePage(page + 1, 'rdvs')" [disabled]="page * pageSize >= totalRdvs">Suivant</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Produits -->
      <div class="section">
        <h2 class="section-title">Produits</h2>
        <div class="chart-filter">
          <label>Période :</label>
          <select [(ngModel)]="productPeriod" (change)="loadProductData()">
            <option value="7days">Derniers 7 jours</option>
            <option value="30days">Derniers 30 jours</option>
            <option value="custom">Personnalisé</option>
          </select>
          <div *ngIf="productPeriod === 'custom'" class="flex space-x-2">
            <input type="date" [(ngModel)]="productStartDate" (change)="loadProductData()">
            <input type="date" [(ngModel)]="productEndDate" (change)="loadProductData()">
          </div>
        </div>
        <div class="chart-grid" *ngIf="!loading; else loadingTemplate">
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Requêtes par Produit (Pie)</h3>
            <canvas baseChart [data]="productChartData" [options]="pieChartOptions" [type]="pieChartType" *ngIf="hasNonZeroData(productChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Tendances des Requêtes par Produit (Bar)</h3>
            <canvas baseChart [data]="productTrendChartData" [options]="barChartOptions" [type]="barChartType" *ngIf="hasNonZeroData(productTrendChartData); else noData"></canvas>
            <ng-template #noData>
              <p class="text-center text-gray-500">Aucune donnée disponible.</p>
            </ng-template>
          </div>
        </div>
        <div class="search-bar-container">
          <div class="search-bar">
            <input type="text" [(ngModel)]="productSearch" (input)="filterProducts()" placeholder="Rechercher un produit...">
            <button><i class="fas fa-search"></i></button>
          </div>
        </div>
        <div class="table-section">
          <h3 class="table-subtitle">Liste des Produits Populaires</h3>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-header">
                <tr>
                  <th>Produit</th>
                  <th>Nombre de Requêtes</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of displayedProducts">
                  <td>{{ product.nom }}</td>
                  <td>{{ product.requestCount }}</td>
                </tr>
                <tr *ngIf="!displayedProducts.length">
                  <td colspan="2" class="text-center">Aucun produit disponible.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>